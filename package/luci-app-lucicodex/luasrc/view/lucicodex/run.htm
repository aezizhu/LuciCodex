<%+header%>

<style>
/* LuciCodex Chat - Modern Minimal Design */
:root {
    --bg-primary: #0a0a0b;
    --bg-secondary: #111113;
    --bg-tertiary: #18181b;
    --bg-elevated: #1f1f23;
    --text-primary: #fafafa;
    --text-secondary: #a1a1aa;
    --text-muted: #71717a;
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --success: #22c55e;
    --error: #ef4444;
    --warning: #f59e0b;
    --border: rgba(255,255,255,0.08);
    --border-hover: rgba(255,255,255,0.15);
    --shadow: 0 4px 24px rgba(0,0,0,0.4);
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 24px;
    --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    --font-mono: "SF Mono", "Fira Code", monospace;
}

/* Scope styles to chat container only - don't override LuCI header */
.chat-container, .chat-container * { box-sizing: border-box; }

/* Page wrapper for dark background */
.lucicodex-page {
    background: var(--bg-primary);
    min-height: calc(100vh - 80px);
    padding: 16px;
    margin: -20px;
    position: relative;
}

/* Extend background to cover any gaps */
.lucicodex-page::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-primary);
    z-index: -1;
}

/* Main Layout */
.chat-container {
    font-family: var(--font);
    color: var(--text-primary);
    -webkit-font-smoothing: antialiased;
    display: flex;
    height: calc(100vh - 140px);
    max-width: 1400px;
    margin: 0 auto;
    background: var(--bg-secondary);
    position: relative;
    z-index: 1;
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow);
}

/* Sidebar */
.sidebar {
    width: 280px;
    background: var(--bg-tertiary);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 16px;
    flex-shrink: 0;
}

.sidebar-brand {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 24px;
}

.sidebar-brand svg {
    width: 28px;
    height: 28px;
    color: var(--accent);
}

.sidebar-brand h1 {
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: -0.02em;
}

.btn-new {
    width: 100%;
    padding: 12px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    margin-bottom: 24px;
}

.btn-new:hover { background: var(--accent-hover); }
.btn-new:active { transform: scale(0.98); }

.sidebar-section {
    margin-bottom: 20px;
}

.sidebar-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 8px;
    font-weight: 600;
}

.sidebar-select, .sidebar-input {
    width: 100%;
    padding: 10px 12px;
    padding-right: 28px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%23a1a1aa' d='M5 7L1 3h8z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
}

.sidebar-select:focus, .sidebar-input:focus {
    border-color: var(--accent);
}

.sidebar-select option {
    background: var(--bg-elevated);
    color: var(--text-primary);
}

.mode-toggle {
    display: flex;
    background: var(--bg-elevated);
    border-radius: var(--radius-sm);
    padding: 4px;
    gap: 4px;
}

.mode-btn {
    flex: 1;
    padding: 8px;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: var(--text-secondary);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
}

.mode-btn.active {
    background: var(--accent);
    color: white;
}

.mode-btn:hover:not(.active) {
    background: rgba(255,255,255,0.05);
}

.history-list {
    flex: 1;
    overflow-y: auto;
    list-style: none;
}

.history-item {
    padding: 10px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 0.85rem;
    color: var(--text-secondary);
    transition: all 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.history-item:hover {
    background: var(--bg-elevated);
    color: var(--text-primary);
}

.history-item.active {
    background: var(--accent);
    color: white;
}

.history-item .delete-btn {
    opacity: 0;
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 4px;
}

.history-item:hover .delete-btn { opacity: 0.7; }
.history-item .delete-btn:hover { opacity: 1; }

/* Main Chat Area */
.chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg-primary);
    min-width: 0;
}

.chat-header {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-secondary);
}

.chat-title {
    font-weight: 500;
    font-size: 0.95rem;
}

.status-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-pill.ready { background: rgba(34,197,94,0.15); color: var(--success); }
.status-pill.busy { background: rgba(59,130,246,0.15); color: var(--accent); }
.status-pill.error { background: rgba(239,68,68,0.15); color: var(--error); }

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
}

.status-pill.busy .status-dot {
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

/* Messages Area */
.messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

/* Welcome Screen */
.welcome {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.welcome-icon {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 24px;
    font-size: 28px;
}

.welcome h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 8px;
}

.welcome p {
    color: var(--text-secondary);
    font-size: 0.95rem;
    max-width: 400px;
    margin-bottom: 32px;
}

.suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    max-width: 600px;
}

.suggestion {
    padding: 10px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 20px;
    color: var(--text-secondary);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
}

.suggestion:hover {
    background: var(--bg-elevated);
    border-color: var(--accent);
    color: var(--text-primary);
    transform: translateY(-2px);
}

/* Message Bubbles */
.message {
    display: flex;
    gap: 12px;
    max-width: 800px;
    width: 100%;
    margin: 0 auto;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.user { flex-direction: row-reverse; }

.avatar {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 0.8rem;
    font-weight: 600;
}

.avatar.user {
    background: var(--bg-elevated);
    color: var(--text-secondary);
}

.avatar.ai {
    background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
    color: white;
}

.avatar svg { width: 18px; height: 18px; }

.bubble-wrap {
    flex: 1;
    max-width: 85%;
}

.message.user .bubble-wrap { display: flex; flex-direction: column; align-items: flex-end; }

.meta {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-bottom: 4px;
}

.bubble {
    padding: 12px 16px;
    border-radius: var(--radius-lg);
    font-size: 0.9rem;
    line-height: 1.5;
}

.bubble.user {
    background: var(--accent);
    color: white;
    border-bottom-right-radius: 4px;
}

.bubble.ai {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-bottom-left-radius: 4px;
}

.bubble.error {
    background: rgba(239,68,68,0.1);
    border-color: rgba(239,68,68,0.3);
}

/* Plan Card */
.plan-card {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.plan-header {
    padding: 12px 16px;
    background: var(--bg-elevated);
    border-bottom: 1px solid var(--border);
    font-weight: 500;
    font-size: 0.85rem;
}

.plan-summary {
    padding: 16px;
    color: var(--text-secondary);
    font-size: 0.9rem;
    border-bottom: 1px solid var(--border);
}

.plan-commands {
    list-style: none;
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.plan-card.collapsed .plan-commands {
    max-height: 0;
}

.plan-card.collapsed .plan-summary {
    border-bottom: none;
}

.plan-toggle {
    display: none;
    width: 100%;
    padding: 10px 16px;
    background: var(--bg-elevated);
    border: none;
    border-top: 1px solid var(--border);
    color: var(--text-secondary);
    font-size: 0.8rem;
    cursor: pointer;
    transition: color 0.2s;
}

.plan-toggle:hover {
    color: var(--text-primary);
}

.plan-card.executed .plan-toggle {
    display: block;
}

.plan-toggle-icon {
    display: inline-block;
    margin-right: 6px;
    transition: transform 0.3s;
}

.plan-card.collapsed .plan-toggle-icon {
    transform: rotate(-90deg);
}

.plan-cmd {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.plan-cmd:last-child { border-bottom: none; }

.plan-cmd input[type="checkbox"] {
    margin-top: 4px;
    accent-color: var(--accent);
}

.plan-cmd-content { flex: 1; }

.plan-cmd-desc {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 6px;
}

.plan-cmd-code {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    background: var(--bg-primary);
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    color: var(--success);
    overflow-x: auto;
}

.plan-actions {
    padding: 12px 16px;
    display: flex;
    gap: 10px;
    background: var(--bg-elevated);
}

.btn-exec {
    padding: 10px 20px;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-exec.approve {
    background: var(--success);
    color: white;
}

.btn-exec.approve:hover { background: #16a34a; }

.btn-exec.reject {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-secondary);
}

.btn-exec.reject:hover {
    background: rgba(239,68,68,0.1);
    border-color: var(--error);
    color: var(--error);
}

/* Terminal Output */
.terminal {
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    overflow: hidden;
    margin-top: 12px;
}

.terminal-header {
    padding: 10px 16px;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.terminal-status {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
}

.terminal-status.success { background: rgba(34,197,94,0.2); color: var(--success); }
.terminal-status.error { background: rgba(239,68,68,0.2); color: var(--error); }
.terminal-status.running { background: rgba(59,130,246,0.2); color: var(--accent); animation: pulse 1.5s infinite; }

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.terminal.streaming .terminal-body {
    min-height: 60px;
}

.term-err {
    color: var(--error);
    font-style: italic;
}

.terminal-body {
    padding: 16px;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    max-height: 300px;
    overflow-y: auto;
    line-height: 1.6;
}

.term-cmd {
    color: var(--success);
    font-weight: 600;
    margin-top: 12px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
}

.term-cmd:first-child { margin-top: 0; }

.term-out {
    color: var(--text-secondary);
    white-space: pre-wrap;
    word-break: break-word;
    padding: 8px 0;
}

/* AI Summary */
.ai-summary {
    margin-top: 12px;
    padding: 16px;
    background: rgba(59,130,246,0.1);
    border: 1px solid rgba(59,130,246,0.2);
    border-radius: var(--radius-md);
}

.ai-summary-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--accent);
    margin-bottom: 8px;
    font-weight: 600;
}

.ai-summary-text {
    font-size: 0.9rem;
    line-height: 1.5;
}

/* Typing Indicator */
.typing {
    display: flex;
    gap: 4px;
    padding: 8px 0;
}

.typing span {
    width: 8px;
    height: 8px;
    background: var(--text-muted);
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out both;
}

.typing span:nth-child(1) { animation-delay: -0.32s; }
.typing span:nth-child(2) { animation-delay: -0.16s; }

@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

/* Input Area */
.input-area {
    padding: 20px 24px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border);
}

.input-wrap {
    display: flex;
    gap: 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 8px 12px;
    align-items: flex-end;
    max-width: 800px;
    margin: 0 auto;
    transition: border-color 0.2s;
}

.input-wrap:focus-within {
    border-color: var(--accent);
}

.input-wrap textarea {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-size: 0.95rem;
    font-family: var(--font);
    resize: none;
    max-height: 120px;
    padding: 8px;
    outline: none;
}

.input-wrap textarea::placeholder {
    color: var(--text-muted);
}

.btn-send {
    width: 40px;
    height: 40px;
    background: var(--accent);
    border: none;
    border-radius: 10px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, transform 0.1s;
    flex-shrink: 0;
}

.btn-send:hover { background: var(--accent-hover); }
.btn-send:active { transform: scale(0.95); }
.btn-send:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-send svg { width: 18px; height: 18px; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }

/* Mobile */
@media (max-width: 768px) {
    .chat-container {
        flex-direction: column;
        height: calc(100vh - 60px);
        margin: 8px;
        border-radius: var(--radius-lg);
    }

    .sidebar {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap;
        padding: 12px;
        gap: 8px;
        border-right: none;
        border-bottom: 1px solid var(--border);
    }

    .sidebar-brand { display: none; }
    .btn-new { width: auto; margin: 0; }
    .sidebar-section { margin: 0; flex: 1; min-width: 120px; }
    .history-list { display: none; }

    .messages { padding: 16px; }
    .input-area { padding: 12px 16px; }
    .suggestions { flex-direction: column; }
    .suggestion { width: 100%; text-align: center; }
}
</style>

<div class="lucicodex-page">
<div class="chat-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-brand">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            <h1>LuciCodex</h1>
        </div>

        <button class="btn-new" onclick="newChat()">+ New Chat</button>

        <div class="sidebar-section">
            <div class="sidebar-label">Mode</div>
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="manual" onclick="setMode('manual')">Review</button>
                <button class="mode-btn" data-mode="auto" onclick="setMode('auto')">Auto</button>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-label">Provider</div>
            <select class="sidebar-select" id="provider" onchange="setProvider()">
                <option value="gemini">Google Gemini</option>
                <option value="openai">OpenAI</option>
                <option value="anthropic">Anthropic</option>
            </select>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-label">Model (optional)</div>
            <input type="text" class="sidebar-input" id="model" placeholder="Default" oninput="setModel()">
        </div>

        <div class="sidebar-section" style="flex:1;overflow:hidden;">
            <div class="sidebar-label" style="display:flex;justify-content:space-between;">
                <span>History</span>
                <button style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.7rem;" onclick="clearHistory()">Clear</button>
            </div>
            <ul class="history-list" id="historyList"></ul>
        </div>
    </aside>

    <!-- Main -->
    <main class="chat-main">
        <header class="chat-header">
            <span class="chat-title">OpenWrt Assistant</span>
            <div class="status-pill ready" id="status">
                <span class="status-dot"></span>
                <span id="statusText">Ready</span>
            </div>
        </header>

        <div class="messages" id="messages">
            <div class="welcome" id="welcome">
                <div class="welcome-icon">ü§ñ</div>
                <h2>Welcome to LuciCodex</h2>
                <p>Your AI-powered router assistant. Ask me anything about managing your OpenWrt device.</p>
                <div class="suggestions">
                    <button class="suggestion" onclick="suggest('Show my connected devices')">üì± Connected devices</button>
                    <button class="suggestion" onclick="suggest('Check system resource usage')">üìä System resources</button>
                    <button class="suggestion" onclick="suggest('Update all packages')">üì¶ Update packages</button>
                    <button class="suggestion" onclick="suggest('Create a guest WiFi network')">üì∂ Guest WiFi</button>
                    <button class="suggestion" onclick="suggest('List firewall rules')">üî• Firewall rules</button>
                    <button class="suggestion" onclick="suggest('Show network interfaces')">üåê Network info</button>
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-wrap">
                <textarea id="input" placeholder="Ask LuciCodex..." rows="1" onkeydown="handleKey(event)" oninput="autoGrow(this)"></textarea>
                <button class="btn-send" id="sendBtn" onclick="send()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>
    </main>
</div>

<script>
// State
var S = {
    mode: 'manual',
    provider: 'gemini',
    model: '',
    history: [],
    sessionId: null,
    messages: [],
    plan: null,
    busy: false
};

var API = {
    plan: '<%=url("admin/system/lucicodex/plan")%>',
    execute: '<%=url("admin/system/lucicodex/execute")%>',
    summarize: '<%=url("admin/system/lucicodex/summarize")%>',
    providers: '<%=url("admin/system/lucicodex/providers")%>',
    ws: (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/cgi-bin/luci/admin/system/lucicodex/ws'
};

// WebSocket connection
var ws = null;
var wsReconnectTimer = null;

function connectWebSocket() {
    if (ws && ws.readyState === WebSocket.OPEN) return;

    try {
        ws = new WebSocket(API.ws);

        ws.onopen = function() {
            console.log('[LuciCodex] WebSocket connected');
        };

        ws.onclose = function() {
            console.log('[LuciCodex] WebSocket closed');
            ws = null;
            // Try reconnect after 5 seconds
            if (wsReconnectTimer) clearTimeout(wsReconnectTimer);
            wsReconnectTimer = setTimeout(connectWebSocket, 5000);
        };

        ws.onerror = function(e) {
            console.warn('[LuciCodex] WebSocket error:', e);
        };
    } catch(e) {
        console.warn('[LuciCodex] WebSocket not available:', e);
    }
}

// Init
document.addEventListener('DOMContentLoaded', function() {
    console.log('[LuciCodex] DOM loaded, initializing...');
    console.log('[LuciCodex] API URLs:', API);
    try {
        loadState();
        connectWebSocket(); // Connect WebSocket for streaming
        loadProviders().then(function() {
            newChat(false);
            console.log('[LuciCodex] Initialization complete');
        }).catch(function(e) {
            console.error('[LuciCodex] Provider load error:', e);
            newChat(false);
        });
    } catch(e) {
        console.error('[LuciCodex] Init error:', e);
    }
});

// Debug: log when script loads
console.log('[LuciCodex] Script loaded');

function loadProviders() {
    console.log('[LuciCodex] Loading providers...');
    return fetch(API.providers, { credentials: 'same-origin' })
        .then(function(r) {
            console.log('[LuciCodex] Providers response status:', r.status);
            if (!r.ok) {
                console.warn('[LuciCodex] Providers endpoint not OK:', r.status);
                return null;
            }
            return r.text();
        })
        .then(function(text) {
            if (!text) return;
            console.log('[LuciCodex] Providers response:', text.substring(0, 200));
            var d = JSON.parse(text);
            var sel = document.getElementById('provider');
            if (d.configured && d.configured.length) {
                // Clear existing options
                sel.innerHTML = '';
                // Validate and create options safely
                var validProviders = ['gemini', 'openai', 'anthropic'];
                var labels = {gemini:'Google Gemini',openai:'OpenAI',anthropic:'Anthropic'};
                for (var i = 0; i < d.configured.length; i++) {
                    var p = d.configured[i];
                    // Only allow known provider values to prevent XSS
                    if (validProviders.indexOf(p) !== -1) {
                        var opt = document.createElement('option');
                        opt.value = p;
                        opt.textContent = labels[p] || p;
                        sel.appendChild(opt);
                    }
                }
                S.provider = validProviders.indexOf(d.default) !== -1 ? d.default : (d.configured[0] || 'gemini');
                sel.value = S.provider;
            }
            console.log('[LuciCodex] Providers loaded, active:', S.provider);
        })
        .catch(function(e) {
            console.warn('[LuciCodex] Failed to load providers:', e);
        });
}

function loadState() {
    S.history = JSON.parse(localStorage.getItem('lc_history') || '[]');
    S.mode = localStorage.getItem('lc_mode') || 'manual';
    S.provider = localStorage.getItem('lc_provider') || 'gemini';
    S.model = localStorage.getItem('lc_model') || '';

    var btns = document.querySelectorAll('.mode-btn');
    for (var i = 0; i < btns.length; i++) {
        btns[i].classList.toggle('active', btns[i].dataset.mode === S.mode);
    }
    document.getElementById('provider').value = S.provider;
    document.getElementById('model').value = S.model;
    renderHistory();
}

function saveState() {
    localStorage.setItem('lc_mode', S.mode);
    localStorage.setItem('lc_provider', S.provider);
    localStorage.setItem('lc_model', S.model);
}

// Actions
function newChat(shouldConfirm) {
    if (typeof shouldConfirm === 'undefined') shouldConfirm = true;
    if (shouldConfirm && S.messages.length > 0 && !window.confirm('Start new chat?')) return;
    S.sessionId = 'sess_' + Date.now();
    S.messages = [];
    S.plan = null;
    document.getElementById('messages').innerHTML = '';
    showWelcome();
    renderHistory();
}

function setMode(m) {
    S.mode = m;
    var btns = document.querySelectorAll('.mode-btn');
    for (var i = 0; i < btns.length; i++) {
        btns[i].classList.toggle('active', btns[i].dataset.mode === m);
    }
    saveState();
}

function setProvider() {
    S.provider = document.getElementById('provider').value;
    S.model = '';
    document.getElementById('model').value = '';
    saveState();
}

function setModel() {
    S.model = document.getElementById('model').value.trim();
    saveState();
}

function suggest(text) {
    document.getElementById('input').value = text;
    send();
}

function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
    }
}

function autoGrow(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

// Core
function send() {
    console.log('[LuciCodex] send() called');
    if (S.busy) {
        console.log('[LuciCodex] busy, skipping');
        return;
    }
    var input = document.getElementById('input');
    var text = input.value.trim();
    if (!text) {
        console.log('[LuciCodex] empty input, skipping');
        return;
    }

    console.log('[LuciCodex] Sending prompt:', text);
    input.value = '';
    autoGrow(input);
    hideWelcome();

    addMsg('user', text);

    if (S.mode === 'auto' && !confirm('Auto mode: Commands will execute immediately. Continue?')) {
        setStatus('ready', 'Ready');
        return;
    }

    setBusy(true);
    addTyping();

    console.log('[LuciCodex] Calling plan API...');
    api(API.plan, { prompt: text, provider: S.provider, model: S.model })
        .then(function(r) {
            console.log('[LuciCodex] Plan API response:', r);
            removeTyping();

            if (!r.ok) throw new Error(r.error || 'Failed to generate plan');

            var cmds = normCmds(r.plan);
            // Create new plan object with commands
            S.plan = {};
            for (var key in r.plan) {
                if (r.plan.hasOwnProperty(key)) S.plan[key] = r.plan[key];
            }
            S.plan.commands = cmds;

            if (cmds.length === 0) {
                addMsg('ai', r.plan.summary || 'No commands needed for this request.');
            } else {
                renderPlan(S.plan);
                if (S.mode === 'auto') execute(text);
            }
            setBusy(false);
            saveSession();
        })
        .catch(function(e) {
            console.error('[LuciCodex] Error in send():', e);
            removeTyping();
            addError(e.message, e.details);
            setBusy(false);
            saveSession();
        });
}

function execute(prompt, cmds) {
    var commands = cmds || getSelectedCmds();
    if (!commands.length) {
        addMsg('ai', 'No commands selected.');
        return;
    }

    // Format commands for API
    var formattedCmds = [];
    for (var i = 0; i < commands.length; i++) {
        var parts = commands[i].split(/\s+/);
        var filtered = [];
        for (var j = 0; j < parts.length; j++) {
            if (parts[j]) filtered.push(parts[j]);
        }
        formattedCmds.push({ command: filtered });
    }

    removeApproval();
    collapsePlan();
    setBusy(true);

    // Try WebSocket streaming first, fallback to HTTP
    if (ws && ws.readyState === WebSocket.OPEN) {
        executeStreaming(prompt, formattedCmds);
    } else {
        executeHttp(prompt, formattedCmds);
    }
}

// Streaming execution via WebSocket
function executeStreaming(prompt, formattedCmds) {
    // Create streaming terminal UI
    var terminalId = 'stream-terminal-' + Date.now();
    var div = document.createElement('div');
    div.className = 'message ai';
    div.id = terminalId;
    div.innerHTML = '<div class="avatar ai">' + getIcon(S.provider) + '</div>' +
        '<div class="bubble-wrap"><div class="bubble ai">' +
        '<div class="terminal streaming">' +
        '<div class="terminal-header"><span>Terminal</span>' +
        '<span class="terminal-status running">Running...</span></div>' +
        '<div class="terminal-body" id="' + terminalId + '-body"></div></div>' +
        '</div></div>';
    document.getElementById('messages').appendChild(div);
    scroll();

    var termBody = document.getElementById(terminalId + '-body');
    var results = [];
    var currentCmdIdx = -1;

    // WebSocket message handler for this execution
    function handleMessage(event) {
        var data;
        try { data = JSON.parse(event.data); } catch(e) { return; }

        switch(data.type) {
            case 'exec_start':
                console.log('[LuciCodex] Execution started, ' + data.data + ' commands');
                break;

            case 'exec_cmd':
                currentCmdIdx = data.index;
                var cmdHtml = '<div class="term-cmd">$ ' + esc(data.command) + '</div>';
                cmdHtml += '<div class="term-out" id="' + terminalId + '-out-' + data.index + '"></div>';
                termBody.innerHTML += cmdHtml;
                scroll();
                break;

            case 'exec_output':
                var outEl = document.getElementById(terminalId + '-out-' + data.index);
                if (outEl) {
                    outEl.innerHTML += esc(data.data) + '\n';
                    scroll();
                }
                break;

            case 'exec_result':
                var result = data.data;
                results.push({
                    command: formattedCmds[data.index] ? formattedCmds[data.index].command : [],
                    output: result.output || '',
                    success: result.success
                });
                // Update output if not already streamed
                var outEl2 = document.getElementById(terminalId + '-out-' + data.index);
                if (outEl2 && !outEl2.innerHTML.trim() && result.output) {
                    outEl2.innerHTML = esc(result.output);
                }
                break;

            case 'done':
                ws.removeEventListener('message', handleMessage);
                // Update terminal status
                var statusEl = div.querySelector('.terminal-status');
                if (statusEl) {
                    statusEl.className = 'terminal-status success';
                    statusEl.textContent = 'Done';
                }
                div.querySelector('.terminal').classList.remove('streaming');

                // Save to state
                S.messages.push({ role: 'ai', type: 'result', items: results, success: true, ts: Date.now() });
                setBusy(false);
                saveSession();

                // Try to get summary
                fetchSummary(prompt, results);
                break;

            case 'error':
                ws.removeEventListener('message', handleMessage);
                var statusEl2 = div.querySelector('.terminal-status');
                if (statusEl2) {
                    statusEl2.className = 'terminal-status error';
                    statusEl2.textContent = 'Error';
                }
                termBody.innerHTML += '<div class="term-err">' + esc(data.error || 'Unknown error') + '</div>';
                setBusy(false);
                saveSession();
                break;
        }
    }

    ws.addEventListener('message', handleMessage);

    // Send execute request
    ws.send(JSON.stringify({
        type: 'execute',
        payload: {
            prompt: prompt,
            provider: S.provider,
            model: S.model,
            commands: formattedCmds,
            dry_run: false,
            timeout: 120
        }
    }));
}

// Fallback HTTP execution
function executeHttp(prompt, formattedCmds) {
    addTyping();

    api(API.execute, {
        prompt: prompt,
        provider: S.provider,
        model: S.model,
        dry_run: false,
        timeout: 120,
        commands: formattedCmds
    })
    .then(function(r) {
        removeTyping();

        if (r.ok) {
            var result = r.result || {};
            var items = result.items || result.Items || [];

            // Show results immediately
            renderResult(items, true, null);
            setBusy(false);
            saveSession();

            // Try to get summary in background
            fetchSummary(prompt, items);
        } else {
            addMsg('ai', 'Execution failed: ' + (r.error || 'Unknown error'));
            setBusy(false);
            saveSession();
        }
    })
    .catch(function(e) {
        removeTyping();
        addError(e.message);
        setBusy(false);
        saveSession();
    });
}

// Fetch summary in background - each summary gets a unique ID to avoid conflicts
var summaryCounter = 0;

function fetchSummary(prompt, items) {
    var summaryCommands = [];
    for (var k = 0; k < items.length; k++) {
        var item = items[k];
        summaryCommands.push({
            command: item.command || item.Command || [],
            output: (item.output || item.Output || '').toString(),
            error: (item.error || item.Error || '').toString()
        });
    }

    // Generate unique ID for this summary request
    var summaryId = 'summary-' + (++summaryCounter) + '-' + Date.now();

    // Show loading placeholder with unique ID
    addSummaryPlaceholder(prompt, items, summaryId);

    api(API.summarize, {
        prompt: prompt,
        provider: S.provider,
        model: S.model,
        commands: summaryCommands
    })
    .then(function(sr) {
        console.log('[LuciCodex] Summary response for ' + summaryId + ':', sr);
        if (sr.ok && sr.summary) {
            console.log('[LuciCodex] Displaying summary:', sr.summary.substring(0, 100));
            replaceSummaryPlaceholder(summaryId, { text: sr.summary, details: sr.details });
            saveSession();
        } else {
            console.log('[LuciCodex] No summary in response');
            showSummaryError(summaryId, prompt, items, 'No summary returned');
        }
    })
    .catch(function(e) {
        console.warn('[LuciCodex] Summary failed for ' + summaryId + ':', e.message);
        showSummaryError(summaryId, prompt, items, e.message);
    });
}

function addSummaryPlaceholder(prompt, items, summaryId) {
    // Find the last terminal and add loading placeholder BEFORE it
    var terminals = document.querySelectorAll('.terminal');
    if (!terminals.length) {
        console.warn('[LuciCodex] No terminal found for summary placeholder');
        return;
    }

    var lastTerminal = terminals[terminals.length - 1];
    var bubble = lastTerminal.closest('.bubble');
    if (!bubble) {
        console.warn('[LuciCodex] No bubble found for summary placeholder');
        return;
    }

    // Remove any existing summary in this bubble only
    var existing = bubble.querySelector('.ai-summary');
    if (existing) existing.remove();

    var placeholder = document.createElement('div');
    placeholder.className = 'ai-summary ai-summary-loading';
    placeholder.id = summaryId;
    placeholder.innerHTML = '<div class="ai-summary-title">AI Summary</div>' +
        '<div class="ai-summary-text">' +
        '<div class="typing"><span></span><span></span><span></span></div>' +
        '<span style="color:var(--text-muted);margin-left:8px;">Generating summary...</span>' +
        '</div>';
    placeholder.setAttribute('data-prompt', prompt);
    placeholder.setAttribute('data-items', JSON.stringify(items));

    // Insert BEFORE terminal instead of after
    bubble.insertBefore(placeholder, lastTerminal);
    console.log('[LuciCodex] Added summary placeholder:', summaryId);
    scroll();
}

function replaceSummaryPlaceholder(summaryId, summary) {
    var placeholder = document.getElementById(summaryId);
    if (!placeholder) {
        console.warn('[LuciCodex] Summary placeholder not found:', summaryId);
        // Fallback to regular add
        addSummaryToLastResult(summary);
        return;
    }

    // Build summary HTML
    var detailsHtml = '';
    if (summary.details && summary.details.length) {
        var detailItems = [];
        for (var j = 0; j < summary.details.length; j++) {
            detailItems.push('<li>' + esc(summary.details[j]) + '</li>');
        }
        detailsHtml = '<ul style="margin-top:8px;padding-left:20px;color:var(--text-secondary);">' + detailItems.join('') + '</ul>';
    }

    placeholder.className = 'ai-summary';
    placeholder.innerHTML = '<div class="ai-summary-title">AI Summary</div>' +
        '<div class="ai-summary-text">' + esc(summary.text) + detailsHtml + '</div>';
    placeholder.removeAttribute('data-prompt');
    placeholder.removeAttribute('data-items');

    console.log('[LuciCodex] Replaced summary placeholder:', summaryId);
    scroll();

    // Update state
    for (var i = S.messages.length - 1; i >= 0; i--) {
        if (S.messages[i].type === 'result') {
            S.messages[i].summary = summary;
            break;
        }
    }
}

function showSummaryError(summaryId, prompt, items, errorMsg) {
    var placeholder = document.getElementById(summaryId);
    if (!placeholder) {
        console.warn('[LuciCodex] Summary placeholder not found for error:', summaryId);
        return;
    }

    placeholder.className = 'ai-summary ai-summary-error';
    placeholder.innerHTML = '<div class="ai-summary-title">AI Summary</div>' +
        '<div class="ai-summary-text" style="color:var(--text-muted);">' +
        'Summary unavailable' + (errorMsg ? ' (' + esc(errorMsg.substring(0, 50)) + ')' : '') +
        '<button class="btn-retry-summary" onclick="retrySummary(this)" style="margin-left:12px;padding:4px 12px;background:var(--accent);color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.8rem;">Retry</button>' +
        '</div>';
    placeholder.setAttribute('data-prompt', prompt);
    placeholder.setAttribute('data-items', JSON.stringify(items));
}

function retrySummary(btn) {
    var summaryEl = btn.closest('.ai-summary');
    if (!summaryEl) return;

    var prompt = summaryEl.getAttribute('data-prompt');
    var items;
    try {
        items = JSON.parse(summaryEl.getAttribute('data-items'));
    } catch(e) {
        items = [];
    }

    if (!prompt || !items.length) return;

    // Re-trigger fetch (will create new placeholder)
    summaryEl.remove();
    fetchSummary(prompt, items);
}

function approve() {
    var reversed = S.messages.slice().reverse();
    var userMsg = null;
    for (var i = 0; i < reversed.length; i++) {
        if (reversed[i].role === 'user') {
            userMsg = reversed[i];
            break;
        }
    }
    var prompt = userMsg ? userMsg.text : null;
    if (prompt) execute(prompt);
}

function reject() {
    removeApproval();
    addMsg('ai', 'Execution cancelled.');
}

// API
function api(url, data) {
    console.log('[LuciCodex] API call:', url, data);
    var responseStatus;
    return fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
        credentials: 'same-origin'  // Include cookies for LuCI session
    })
    .then(function(r) {
        responseStatus = r.status;
        console.log('[LuciCodex] Response status:', r.status);
        return r.text();
    })
    .then(function(text) {
        console.log('[LuciCodex] Response text:', text.substring(0, 500));

        var json;
        try {
            json = JSON.parse(text);
        } catch (parseErr) {
            console.error('[LuciCodex] JSON parse error:', parseErr);
            throw new Error('Invalid response from server. Check if daemon is running.');
        }

        if (responseStatus < 200 || responseStatus >= 300) {
            var e = new Error(json.error || 'Request failed (' + responseStatus + ')');
            e.details = json.details;
            throw e;
        }
        return json;
    })
    .catch(function(fetchErr) {
        console.error('[LuciCodex] Fetch error:', fetchErr);
        throw fetchErr;
    });
}

// Helpers
function normCmds(plan) {
    if (!plan || !plan.commands) return [];
    if (Array.isArray(plan.commands)) return plan.commands;
    var vals = [];
    var keys = Object.keys(plan.commands);
    for (var i = 0; i < keys.length; i++) {
        if (plan.commands[keys[i]]) vals.push(plan.commands[keys[i]]);
    }
    return vals;
}

function getSelectedCmds() {
    var cmds = [];
    var els = document.querySelectorAll('.plan-cmd');
    for (var i = 0; i < els.length; i++) {
        var cb = els[i].querySelector('input[type="checkbox"]');
        var code = els[i].querySelector('.plan-cmd-code');
        if (cb && cb.checked && code) cmds.push(code.textContent.trim());
    }
    return cmds;
}

function esc(s) {
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// UI
function showWelcome() {
    var el = document.getElementById('welcome');
    if (!el) {
        // Recreate welcome element if it was cleared
        el = document.createElement('div');
        el.className = 'welcome';
        el.id = 'welcome';
        el.innerHTML = '<div class="welcome-icon">ü§ñ</div>' +
            '<h2>Welcome to LuciCodex</h2>' +
            '<p>Your AI-powered router assistant. Ask me anything about managing your OpenWrt device.</p>' +
            '<div class="suggestions">' +
            '<button class="suggestion" onclick="suggest(\'Show my connected devices\')">üì± Connected devices</button>' +
            '<button class="suggestion" onclick="suggest(\'Check system resource usage\')">üìä System resources</button>' +
            '<button class="suggestion" onclick="suggest(\'Update all packages\')">üì¶ Update packages</button>' +
            '<button class="suggestion" onclick="suggest(\'Create a guest WiFi network\')">üì∂ Guest WiFi</button>' +
            '<button class="suggestion" onclick="suggest(\'List firewall rules\')">üî• Firewall rules</button>' +
            '<button class="suggestion" onclick="suggest(\'Show network interfaces\')">üåê Network info</button>' +
            '</div>';
        document.getElementById('messages').appendChild(el);
    }
    el.style.display = 'flex';
}
function hideWelcome() {
    var el = document.getElementById('welcome');
    if (el) el.style.display = 'none';
}

function setStatus(type, text) {
    var el = document.getElementById('status');
    el.className = 'status-pill ' + type;
    document.getElementById('statusText').textContent = text;
}

function setBusy(busy) {
    S.busy = busy;
    document.getElementById('input').disabled = busy;
    document.getElementById('sendBtn').disabled = busy;
    setStatus(busy ? 'busy' : 'ready', busy ? 'Processing...' : 'Ready');
    if (!busy) document.getElementById('input').focus();
}

function scroll() {
    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
}

function addMsg(role, text) {
    S.messages.push({ role: role, text: text, ts: Date.now() });

    var div = document.createElement('div');
    div.className = 'message ' + role;

    var time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    var avatar = role === 'user' ? 'U' : getIcon(S.provider);
    var sender = role === 'user' ? 'You' : 'AI';

    div.innerHTML = '<div class="avatar ' + role + '">' + avatar + '</div>' +
        '<div class="bubble-wrap">' +
        '<div class="meta">' + sender + ' - ' + time + '</div>' +
        '<div class="bubble ' + role + '">' + parseText(text) + '</div>' +
        '</div>';

    document.getElementById('messages').appendChild(div);
    scroll();
}

function addError(msg, details) {
    var html = '<strong>Error:</strong> ' + esc(msg);
    if (details && details.backend_error) {
        html += '<br><br><code style="font-size:0.8rem;color:var(--text-muted);">' + esc(details.backend_error) + '</code>';
    }

    var div = document.createElement('div');
    div.className = 'message ai';
    div.innerHTML = '<div class="avatar ai">' + getIcon(S.provider) + '</div>' +
        '<div class="bubble-wrap"><div class="bubble ai error">' + html + '</div></div>';
    document.getElementById('messages').appendChild(div);
    scroll();
}

function addTyping() {
    var div = document.createElement('div');
    div.className = 'message ai';
    div.id = 'typing';
    div.innerHTML = '<div class="avatar ai">' + getIcon(S.provider) + '</div>' +
        '<div class="bubble-wrap"><div class="bubble ai">' +
        '<div class="typing"><span></span><span></span><span></span></div>' +
        '</div></div>';
    document.getElementById('messages').appendChild(div);
    scroll();
}

function removeTyping() {
    var el = document.getElementById('typing');
    if (el) el.remove();
}

function removeApproval() {
    var els = document.querySelectorAll('.plan-actions');
    for (var i = 0; i < els.length; i++) {
        els[i].remove();
    }
}

function renderPlan(plan) {
    S.messages.push({ role: 'ai', type: 'plan', plan: plan, ts: Date.now() });

    var cmdsHtml = [];
    for (var i = 0; i < plan.commands.length; i++) {
        var c = plan.commands[i];
        var cmd = Array.isArray(c.command) ? c.command.join(' ') : (c.command || '');
        var desc = c.description || ('Command ' + (i + 1));
        cmdsHtml.push('<li class="plan-cmd"><input type="checkbox" checked><div class="plan-cmd-content"><div class="plan-cmd-desc">' + esc(desc) + '</div><div class="plan-cmd-code">' + esc(cmd) + '</div></div></li>');
    }
    var cmds = cmdsHtml.join('');
    var summaryHtml = plan.summary ? '<div class="plan-summary">' + esc(plan.summary) + '</div>' : '';
    var cmdCount = plan.commands.length;

    var div = document.createElement('div');
    div.className = 'message ai';
    div.innerHTML = '<div class="avatar ai">' + getIcon(S.provider) + '</div>' +
        '<div class="bubble-wrap">' +
        '<div class="plan-card">' +
        '<div class="plan-header">Execution Plan</div>' +
        summaryHtml +
        '<ul class="plan-commands">' + cmds + '</ul>' +
        '<button class="plan-toggle" onclick="togglePlan(this)"><span class="plan-toggle-icon">‚ñº</span>Show ' + cmdCount + ' command' + (cmdCount > 1 ? 's' : '') + '</button>' +
        '<div class="plan-actions">' +
        '<button class="btn-exec approve" onclick="approve()">Execute</button>' +
        '<button class="btn-exec reject" onclick="reject()">Cancel</button>' +
        '</div></div></div>';
    document.getElementById('messages').appendChild(div);
    scroll();
}

function togglePlan(btn) {
    var planCard = btn.closest('.plan-card');
    if (!planCard) return;

    var isCollapsed = planCard.classList.contains('collapsed');
    planCard.classList.toggle('collapsed');

    var cmdCount = planCard.querySelectorAll('.plan-cmd').length;
    btn.innerHTML = '<span class="plan-toggle-icon">‚ñº</span>' +
        (isCollapsed ? 'Hide' : 'Show ' + cmdCount) + ' command' + (cmdCount > 1 ? 's' : '');
}

function collapsePlan() {
    // Find all plan cards and collapse them after execution
    var planCards = document.querySelectorAll('.plan-card:not(.executed)');
    for (var i = 0; i < planCards.length; i++) {
        var card = planCards[i];
        card.classList.add('executed', 'collapsed');

        var toggle = card.querySelector('.plan-toggle');
        if (toggle) {
            var cmdCount = card.querySelectorAll('.plan-cmd').length;
            toggle.innerHTML = '<span class="plan-toggle-icon">‚ñº</span>Show ' + cmdCount + ' command' + (cmdCount > 1 ? 's' : '');
        }
    }
}

function renderResult(items, success, summary) {
    S.messages.push({ role: 'ai', type: 'result', items: items, success: success, summary: summary, ts: Date.now() });

    var outputParts = [];
    for (var i = 0; i < items.length; i++) {
        var item = items[i];
        var cmdArr = item.command || item.Command;
        var cmd = Array.isArray(cmdArr) ? cmdArr.join(' ') : (cmdArr || '');
        var out = (item.output || item.Output || '').trim() || '(no output)';
        var err = item.error || item.Error || '';
        outputParts.push('<div class="term-cmd">$ ' + esc(cmd) + '</div><div class="term-out">' + esc(out) + (err ? '\nError: ' + esc(err) : '') + '</div>');
    }
    var output = outputParts.join('');

    var summaryHtml = '';
    if (summary) {
        var detailsHtml = '';
        if (summary.details && summary.details.length) {
            var detailItems = [];
            for (var j = 0; j < summary.details.length; j++) {
                detailItems.push('<li>' + esc(summary.details[j]) + '</li>');
            }
            detailsHtml = '<ul style="margin-top:8px;padding-left:20px;color:var(--text-secondary);">' + detailItems.join('') + '</ul>';
        }
        summaryHtml = '<div class="ai-summary"><div class="ai-summary-title">AI Summary</div><div class="ai-summary-text">' + esc(summary.text) + detailsHtml + '</div></div>';
    }

    var div = document.createElement('div');
    div.className = 'message ai';
    div.innerHTML = '<div class="avatar ai">' + getIcon(S.provider) + '</div>' +
        '<div class="bubble-wrap"><div class="bubble ai">' +
        summaryHtml +
        '<div class="terminal">' +
        '<div class="terminal-header"><span>Terminal</span>' +
        '<span class="terminal-status ' + (success ? 'success' : 'error') + '">' + (success ? 'Done' : 'Error') + '</span></div>' +
        '<div class="terminal-body">' + output + '</div></div>' +
        '</div></div>';
    document.getElementById('messages').appendChild(div);
    scroll();
}

function addSummaryToLastResult(summary) {
    // Find the last terminal element and add summary BEFORE it
    var terminals = document.querySelectorAll('.terminal');
    if (!terminals.length) return;

    var lastTerminal = terminals[terminals.length - 1];
    var bubble = lastTerminal.closest('.bubble');
    if (!bubble) return;

    // Check if summary already exists
    if (bubble.querySelector('.ai-summary')) return;

    // Build summary HTML
    var detailsHtml = '';
    if (summary.details && summary.details.length) {
        var detailItems = [];
        for (var j = 0; j < summary.details.length; j++) {
            detailItems.push('<li>' + esc(summary.details[j]) + '</li>');
        }
        detailsHtml = '<ul style="margin-top:8px;padding-left:20px;color:var(--text-secondary);">' + detailItems.join('') + '</ul>';
    }
    var summaryEl = document.createElement('div');
    summaryEl.className = 'ai-summary';
    summaryEl.innerHTML = '<div class="ai-summary-title">AI Summary</div><div class="ai-summary-text">' + esc(summary.text) + detailsHtml + '</div>';

    // Insert BEFORE terminal instead of after
    bubble.insertBefore(summaryEl, lastTerminal);
    scroll();

    // Update state for session persistence
    for (var i = S.messages.length - 1; i >= 0; i--) {
        if (S.messages[i].type === 'result') {
            S.messages[i].summary = summary;
            break;
        }
    }
}

function parseText(text) {
    if (!text) return '';
    var h = esc(text);
    h = h.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    h = h.replace(/`(.*?)`/g, '<code>$1</code>');
    h = h.replace(/\n/g, '<br>');
    return h;
}

function getIcon(p) {
    var icons = {
        gemini: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>',
        openai: '<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3"/></svg>',
        anthropic: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 22h20L12 2z" fill="none" stroke="currentColor" stroke-width="2"/></svg>'
    };
    return icons[p] || 'AI';
}

// History
function saveSession() {
    if (S.messages.length < 2) return;

    var userMsg = null;
    for (var i = 0; i < S.messages.length; i++) {
        if (S.messages[i].role === 'user') {
            userMsg = S.messages[i];
            break;
        }
    }
    var title = (userMsg && userMsg.text) ? userMsg.text : 'Chat';
    var short = title.length > 25 ? title.slice(0, 25) + '...' : title;

    var sess = { id: S.sessionId, title: short, ts: Date.now(), messages: S.messages };
    var idx = -1;
    for (var j = 0; j < S.history.length; j++) {
        if (S.history[j].id === sess.id) {
            idx = j;
            break;
        }
    }

    if (idx >= 0) S.history[idx] = sess;
    else S.history.unshift(sess);

    if (S.history.length > 15) S.history.pop();

    localStorage.setItem('lc_history', JSON.stringify(S.history));
    renderHistory();
}

function loadSession(id) {
    // Validate session ID format
    if (!/^sess_\d+$/.test(id)) return;
    var sess = null;
    for (var i = 0; i < S.history.length; i++) {
        if (S.history[i].id === id) {
            sess = S.history[i];
            break;
        }
    }
    if (!sess) return;

    S.sessionId = sess.id;
    S.messages = sess.messages;

    document.getElementById('messages').innerHTML = '';
    hideWelcome();

    for (var j = 0; j < sess.messages.length; j++) {
        var m = sess.messages[j];
        if (m.role === 'user') {
            addMsgDirect('user', m.text);
        } else if (m.type === 'plan') {
            renderPlanDirect(m.plan);
        } else if (m.type === 'result') {
            renderResultDirect(m.items, m.success, m.summary);
        } else {
            addMsgDirect('ai', m.text);
        }
    }

    renderHistory();
}

function addMsgDirect(role, text) {
    var div = document.createElement('div');
    div.className = 'message ' + role;
    div.innerHTML = '<div class="avatar ' + role + '">' + (role === 'user' ? 'U' : getIcon(S.provider)) + '</div>' +
        '<div class="bubble-wrap"><div class="bubble ' + role + '">' + parseText(text) + '</div></div>';
    document.getElementById('messages').appendChild(div);
}

function renderPlanDirect(plan) {
    var cmdsHtml = [];
    for (var i = 0; i < plan.commands.length; i++) {
        var c = plan.commands[i];
        var cmd = Array.isArray(c.command) ? c.command.join(' ') : (c.command || '');
        cmdsHtml.push('<li style="padding:8px 0;border-bottom:1px solid var(--border);"><code style="color:var(--success);">' + esc(cmd) + '</code></li>');
    }
    var cmds = cmdsHtml.join('');
    var summaryHtml = plan.summary ? '<div class="plan-summary">' + esc(plan.summary) + '</div>' : '';

    var div = document.createElement('div');
    div.className = 'message ai';
    div.innerHTML = '<div class="avatar ai">' + getIcon(S.provider) + '</div>' +
        '<div class="bubble-wrap"><div class="plan-card">' +
        '<div class="plan-header">Plan</div>' +
        summaryHtml +
        '<ul class="plan-commands" style="list-style:none;">' + cmds + '</ul>' +
        '</div></div>';
    document.getElementById('messages').appendChild(div);
}

function renderResultDirect(items, success, summary) {
    var outputParts = [];
    for (var i = 0; i < items.length; i++) {
        var item = items[i];
        var cmdArr = item.command || item.Command;
        var cmd = Array.isArray(cmdArr) ? cmdArr.join(' ') : '';
        var out = (item.output || item.Output || '').trim() || '(no output)';
        outputParts.push('<div class="term-cmd">$ ' + esc(cmd) + '</div><div class="term-out">' + esc(out) + '</div>');
    }
    var output = outputParts.join('');
    var summaryHtml = summary ? '<div class="ai-summary"><div class="ai-summary-title">AI Summary</div><div class="ai-summary-text">' + esc(summary.text) + '</div></div>' : '';

    var div = document.createElement('div');
    div.className = 'message ai';
    div.innerHTML = '<div class="avatar ai">' + getIcon(S.provider) + '</div>' +
        '<div class="bubble-wrap"><div class="bubble ai">' +
        summaryHtml +
        '<div class="terminal">' +
        '<div class="terminal-header"><span>Terminal</span><span class="terminal-status ' + (success ? 'success' : 'error') + '">' + (success ? 'Done' : 'Error') + '</span></div>' +
        '<div class="terminal-body">' + output + '</div></div>' +
        '</div></div>';
    document.getElementById('messages').appendChild(div);
}

function renderHistory() {
    var el = document.getElementById('historyList');
    el.innerHTML = '';
    for (var i = 0; i < S.history.length; i++) {
        var h = S.history[i];
        // Validate session ID format (sess_timestamp)
        if (!/^sess_\d+$/.test(h.id)) continue;

        var li = document.createElement('li');
        li.className = 'history-item' + (h.id === S.sessionId ? ' active' : '');
        li.setAttribute('data-id', h.id);
        li.onclick = function() { loadSession(this.getAttribute('data-id')); };

        var span = document.createElement('span');
        span.textContent = h.title || 'Chat';

        var btn = document.createElement('button');
        btn.className = 'delete-btn';
        btn.textContent = String.fromCharCode(215);
        btn.setAttribute('data-id', h.id);
        btn.onclick = function(e) { deleteSession(this.getAttribute('data-id'), e); };

        li.appendChild(span);
        li.appendChild(btn);
        el.appendChild(li);
    }
}

function deleteSession(id, e) {
    e.stopPropagation();
    // Validate session ID format
    if (!/^sess_\d+$/.test(id)) return;
    if (!confirm('Delete this chat?')) return;
    var newHistory = [];
    for (var i = 0; i < S.history.length; i++) {
        if (S.history[i].id !== id) newHistory.push(S.history[i]);
    }
    S.history = newHistory;
    localStorage.setItem('lc_history', JSON.stringify(S.history));
    if (id === S.sessionId) newChat(false);
    else renderHistory();
}

function clearHistory() {
    if (!confirm('Clear all history?')) return;
    S.history = [];
    localStorage.removeItem('lc_history');
    newChat(false);
}
</script>
</div>

<%+footer%>
